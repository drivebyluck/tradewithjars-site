<script>
let pendingCalc = null;

function toggleMode(mode) {
  document.querySelectorAll('.mode-section').forEach(el => el.classList.remove('active'));
  document.getElementById(mode).classList.add('active');
  document.querySelectorAll('.mode-toggle button').forEach(btn => btn.classList.remove('active'));
  document.getElementById('btn-' + mode).classList.add('active');
}

function showPasswordPrompt(callback) {
  pendingCalc = callback;
  document.getElementById('passwordModal').style.display = 'flex';
  setTimeout(() => document.getElementById('accessCodeInput').focus(), 100);
}

function verifyCode() {
  const code = document.getElementById('accessCodeInput').value;
  if (code === '1134') {
    document.getElementById('passwordModal').style.display = 'none';
    document.getElementById('accessCodeInput').value = '';
    if (pendingCalc) pendingCalc();
  } else {
    alert("Please request a new code from the Doughboi's Bakery Discord.");
    document.getElementById('accessCodeInput').value = '';
  }
}

async function calculateControlled() {
  showPasswordPrompt(async () => {
    const investment = parseFloat(c_investment.value);
    const profit = parseFloat(c_profit.value);
    const loss = parseFloat(c_loss.value);
    const leverage = parseFloat(c_leverage.value);
    const entry = parseFloat(c_entry.value);
    const direction = c_direction.value;

    if ([investment, profit, loss, leverage, entry].some(isNaN)) {
      c_result.textContent = "Fill all fields.";
      return;
    }

    try {
      const response = await fetch('https://jars-backend.onrender.com/calculate/controlled', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ investment, profit, loss, leverage, entry, direction })
      });

      const data = await response.json();
      if (data.error) {
        c_result.textContent = data.error;
      } else {
        c_result.textContent = `TP: $${data.tp} | SL: $${data.sl}`;
      }
    } catch (err) {
      c_result.textContent = 'Error connecting to backend.';
    }
  });
}
</script>
