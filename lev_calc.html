<script>
    let pendingCalc = null;
    const PASSWORD_KEY = 'jars_password_verified';

    window.onload = () => {
      if (sessionStorage.getItem(PASSWORD_KEY) !== 'true') {
        document.getElementById('passwordModal').style.display = 'flex';
        setTimeout(() => document.getElementById('accessCodeInput').focus(), 100);
      }
    };

    function toggleMode(mode) {
      document.querySelectorAll('.mode-section').forEach(el => el.classList.remove('active'));
      document.getElementById(mode).classList.add('active');
      document.querySelectorAll('.mode-toggle button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('btn-' + mode).classList.add('active');
    }

    function showPasswordPrompt(callback) {
      if (sessionStorage.getItem(PASSWORD_KEY) === 'true') {
        if (callback) callback();
        return;
      }
      pendingCalc = callback;
      document.getElementById('passwordModal').style.display = 'flex';
      setTimeout(() => document.getElementById('accessCodeInput').focus(), 100);
    }

    function verifyCode() {
      const code = document.getElementById('accessCodeInput').value;
      if (code === '1134') {
        sessionStorage.setItem(PASSWORD_KEY, 'true');
        document.getElementById('passwordModal').style.display = 'none';
        document.getElementById('accessCodeInput').value = '';
        if (pendingCalc) pendingCalc();
      } else {
        alert("Please request a new code from the Doughboi's Bakery Discord.");
        document.getElementById('accessCodeInput').value = '';
      }
    }

    function calculate(mode) {
      showPasswordPrompt(async () => {
        let payload = {};
        if (mode === 'controlled') {
          payload = {
            investment: parseFloat(c_investment.value),
            profit: parseFloat(c_profit.value),
            loss: parseFloat(c_loss.value),
            leverage: parseFloat(c_leverage.value),
            entry: parseFloat(c_entry.value),
            direction: c_direction.value
          };
        } else if (mode === 'degen') {
          payload = {
            entry: parseFloat(d_entry.value),
            exit: parseFloat(d_exit.value),
            leverage: parseFloat(d_leverage.value),
            direction: d_direction.value
          };
        } else if (mode === 'scalp') {
          payload = {
            size: parseFloat(s_size.value),
            entry: parseFloat(s_entry.value),
            exit: parseFloat(s_exit.value),
            leverage: parseFloat(s_leverage.value),
            direction: s_direction.value
          };
        }

        const isInvalid = Object.values(payload).some(v => typeof v === 'number' && isNaN(v));
        if (isInvalid) {
          document.getElementById(mode[0] + '_result').textContent = "Fill all fields.";
          return;
        }

        try {
          const response = await fetch(`https://jars-backend.onrender.com/calculate/${mode}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await response.json();
          const resultDiv = document.getElementById(mode[0] + '_result');
          resultDiv.textContent = data.error ? data.error : data.result || 'Success.';
        } catch (err) {
          document.getElementById(mode[0] + '_result').textContent = 'Error connecting to backend.';
        }
      });
    }
</script>
